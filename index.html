
<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8" />
  <title>Importa Muitas Deklarācija - SIA MMD Serviss</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    @media print {
  .no-print { display: none !important; }
      @page { margin: 8mm; }
      body { transform: scale(0.95); transform-origin: top left; font-size: 11px; line-height: 1.1; }
      table, th, td { font-size: 11px; padding: 3px; }
    }
    body { font-family: Arial, sans-serif; padding: 8px 12px; margin: 0; }
    h1 { font-size: 18px; margin: 4px 0; }
    h2 { font-size: 13px; margin: 10px 0 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 8px; table-layout: fixed; }
    th, td { border: 1px solid #aaa; padding: 3px; text-align: left; font-size: 11px; }
    .barcode { margin-top: 6px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .header-text { font-weight: bold; font-size: 16px; }
    .col-nr { width: 5%; }
    .col-apraksts { width: 30%; word-break: break-word; }
    .col-other { width: 8%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .col-kn { width: 8%; white-space: nowrap; }
    .value-split { display: flex; flex-direction: column; }
  .print-button { margin: 10px 0; padding: 6px 12px; font-size: 12px; cursor: pointer; }
</style>
</head>
<body>
  <div class="header">
    <h1>Importa Muitas Deklarācija</h1>
    <div class="header-text">SIA MMD Serviss</div>
  </div>

  <input type="file" id="fileInput" accept="application/json" class="no-print"/>
  <svg id="barcode" class="barcode" style="display: none;"></svg>
  <div id="declaration"></div>

<script type="module">
  const { jsPDF } = window.jspdf;

  document.getElementById("fileInput").addEventListener("change", function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          JsBarcode("#barcode", data.mrn, { format: "CODE128", height: 40 });
          showDeclaration(data);
        } catch (error) {
          alert("Kļūda! Nepareizs JSON formāts.");
        }
      };
      reader.readAsText(file);
    }
  });

  function showDeclaration(d) {
    const item = d.goodsShipment[0].goodsItems[0];
    document.getElementById("declaration").innerHTML = `
      <h2><strong>MRN:</strong> ${d.mrn}</h2><button class="print-button no-print" onclick="window.print()">Izdrukāt deklarāciju</button>
      <table>
        <tr><th>Deklarācijas tips</th><td>${d.declarationType} - ${d.additionalDeclarationType}</td></tr>
        <tr><th>LRN</th><td>${d.lrn}</td></tr>
        <tr><th>Statuss</th><td>${d.status}</td></tr>
        <tr><th>Muitas iestāde</th><td>${d.customsOfficeIdSupervising}</td></tr>
        <tr><th>Procedūra</th><td>${d.procedure}</td></tr>
        <tr><th>Papildprocedūra</th><td>${d.additionalProcedure}</td></tr>
        <tr><th>Deklarācijas datums</th><td>${new Date(d.declDate).toLocaleDateString()}</td></tr>
        <tr><th>Apstiprināšanas datums</th><td>${new Date(d.acceptDate).toLocaleString()}</td></tr>
        <tr><th>Atbrīvošanas datums</th><td>${new Date(d.releaseDate).toLocaleString()}</td></tr>
        <tr><th>Deklarants</th><td>${d.involvedPerson.declarant.name}</td></tr>
        <tr><th>Importētājs</th><td>${d.involvedPerson.importer.name}</td></tr>
        <tr><th>Iesniedzējs</th><td>${d.involvedPerson.submitter.name}</td></tr>
      </table>
      <h2>Preču saraksts</h2>
      <table>
        <tr>
          <th class="col-nr">Nr.</th>
          <th class="col-apraksts">Apraksts</th>
          <th class="col-kn">KN kods</th>
          <th class="col-other">Iepriekš. proc.</th>
          <th class="col-other">Izc. valsts</th>
          <th class="col-other">Bruto</th>
          <th class="col-other">Neto</th>
          <th class="col-other">Vērtība</th>
          <th class="col-other">Iepakojums</th>
          <th class="col-other">Daudzums</th>
        </tr>
        ${d.goodsShipment[0].goodsItems.map((item, i) => `
          <tr>
            <td class="col-nr">${i + 1}</td>
            <td class="col-apraksts">${item.information.descriptionOfGoods}</td>
            <td class="col-kn">${item.information.commodityCode}</td>
            <td class="col-other">${item.information.previousProcedure}</td>
            <td class="col-other">${item.information.countryOfOrigin}</td>
            <td class="col-other">${parseFloat(item.value.grossMass).toFixed(2)}</td>
            <td class="col-other">${parseFloat(item.value.netMass).toFixed(2)}</td>
            <td class="col-other"><div class="value-split">${item.value.statCalculation.invoice.amount}<span>${item.value.statCalculation.invoice.currency}</span></div></td>
            <td class="col-other">${item.value.packaging[0].packageType}</td>
            <td class="col-other">${item.value.packaging[0].numberOfPackages}</td>
          </tr>`).join('')}
      </table>
      <h2>Nodokļu informācija</h2>
      <table>
        <tr><th>Veids</th><th>Bāze</th><th>Likme</th><th>Summa</th></tr>
        ${
          (() => {
            const allTaxes = {};
            d.goodsShipment[0].goodsItems.forEach(item => {
              item.value.tax?.forEach(tax => {
                if (!allTaxes[tax.type]) {
                  allTaxes[tax.type] = { base: 0, rate: tax.rate, taxRateCurrency: tax.taxRateCurrency, amount: 0 };
                }
                allTaxes[tax.type].base += parseFloat(tax.base);
                allTaxes[tax.type].amount += parseFloat(tax.amount);
              });
            });
            return Object.entries(allTaxes).map(([type, tax]) => `
              <tr>
                <td>${type}</td>
                <td>${tax.base.toFixed(2)}</td>
                <td>${tax.rate} ${tax.taxRateCurrency}</td>
                <td>${tax.amount.toFixed(2)}</td>
              </tr>`).join('') || '<tr><td colspan="4">Nav informācijas par nodokļiem</td></tr>';
          })()
        }
      </table>`;
  }
</script>

<script>
// Защита от копирования
document.addEventListener('contextmenu', event => event.preventDefault());
document.addEventListener('selectstart', event => event.preventDefault());
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && (e.key === 'c' || e.key === 'u' || e.key === 's')) {
    e.preventDefault();
  }
});
</script>

</body>
</html>
